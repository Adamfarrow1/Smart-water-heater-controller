# SD-SWHC
This project involves the development of a Smart Water Heater Controller using ESP32 technology. The goal was to create an energy-efficient system that could monitor and control water heater usage based on user-defined parameters and environmental data.

# Developing using a Windows computer (limited see MacOS section for full functionality):

**important** : if you plan on developing with windows you need to comment out any of the imports and functions that use "@react-native-google-signin/google-signin" (login.js) or "@orbital-systems/react-native-esp-idf-provisioning" (BLEdemo.js, AddDevice.js, ScanScreen.js) 

**Prequisites**:
- Node.js installed
- Expo CLI installed globally: "npm install -g expo-cli"

**VScode:**
- run "npm install" inside the terminal to install node_modules
- run "npm start" or "npx expo start" to begin developement server
- Now use the "expo go" app to scan the QR code that is provided
- You can now see the application on the phone 



# Developing using a MacOS:

**VScode:**
- run npm install to install node_modules
- use npx expo prebuild -p ios to generate an ios folder.
- Open the file with the ext .xcworkspace in the ios folder that was generated by the prebuild command. This file needs to be open on Xcode.

**Xcode:**
- Once you've opened your .xcworkspace 
- In Signing & Capabilities,
    - Team: click on the drop down and select your team for example : Ximena Ramirez (Personal Team)
    - remove Push Notifications from capabilies if you're not using a paid subcription of an Apple Developer account.
    - Add your iPhone device in Xcode. To view this window, choose Window > Devices and Simulators. View and configure simulated devices from the Simulators tab. Use the (+) button to add and configure your iPhone for testing.
 
**Running the app on an iPhone (must be on the same wifi network and sharing the same ip address):**
- on VScode: use command "npx expo start" to start the metro server
- on Xcode: use Build to compile and run the app on your iPhone.

**Running the app on an iPhone (no active metro server, using jsbundle instead).**
In order for the app to run on an iPhone with no active metro server running on vscode, you must generate a jsbundle file.
- on VScode: Build bundle with npx expo export:embed --entry-file='node_modules/expo/AppEntry.js' --bundle output='./ios/main.jsbundle' --dev=false --platform='ios'
- Xcode: Click on top bar of the project, select "Edit Scheme", select "Build Configuration" - Release
  -  Build phases -> Bundle React Native code and images -> Check off "For install builds only" if it's checked
- On Xcode, select your connected device and run the app.

# Running the ESP32:
**WifiProv:**
- Library to provision wifi credentials over BLE signal. You can learn more about WifiProv in [https://github.com/espressif/arduino-esp32/tree/master/libraries/WiFiProv/
](https://github.com/espressif/arduino-esp32/tree/master/libraries/WiFiProv/examples/WiFiProv)
- Per the github link above, WifiProv.beginprovision includes a bool variable reset_provisioned: Resets previously provisioned data before initializing. Using this prevents problem when the device automatically connects to previously connected Wi-Fi and therefore cannot be found.
    - If set to false, the ESP32 will attempt to reconnect to the last saved Wi-Fi network. Once the ESP32 reconnects to Wi-Fi, it connects to Firebase with the last saved device ID and continues to update the Realtime Database. This was mainly used to ensure that even if the ESP32 is shut off or loses connection, it will attempt to reconnect to the same Wi-Fi.
    - If set to true, the ESP32 will ask for provisioning credentials every time it is powered on. A new device ID will also be generated. This is mainly used to simulate a situation where different devices are being added and need to be connected to Wi-Fi for the first time.

**Firebase ESP Client:**
- Use this link for more information about this library: https://github.com/rolan37/Firebase-ESP-Client-main

**SimpleBLE:**
- In the case where the esp32 is already connected to wifi, SimpleBLE was used to broadcast a BLE signal to be disoverable by the our mobile app. If this signal was being broadcast, that meant that the mobile app can send the new user UID through a POST request. After some research, we did find that broadcasting a BLE signal continuously can take up a lot of memory and space. Therefore, we provided an alternative.

**REST API:**
- An alternative to a user adding an existing device to their account would be sending the user’s UID over the wifi network. If the mobile app and esp32 are connected to the same network, we can send the user’s uid to the esp32 and the esp32 will update the realtime database accordingly. 

**Stochastic Algorithm Filter**
- The stochastic algorithm incorporated in the function manageWaterHeaterLoad(float ft) function uses probabilistic decision-making to control the water heater's state (on or off) based on grid frequency conditions.
    This function manages the water heater's load by considering:
    - The current grid frequency (ft).
    - Randomness to make decisions probabilistically.
    - The state of the water heater and external factors like scheduled off periods.
    
- The function controlWaterHeater executes the decision made by manageWaterHeaterLoad by:
    - Turning the heater on or off.
    - Updating the Firebase Realtime Database (RTDB) with the current status.

Note: This sketch takes up a lot of space for the app and may not be able to flash with default setting on some chips.
  If you see Error like this: "Sketch too big"
  In Arduino IDE go to: Tools > Partition scheme > chose anything that has more than 1.4MB APP
  - Tools > Partition scheme > Huge APP
  - Tools > Flash mode > to QIO
   
     
